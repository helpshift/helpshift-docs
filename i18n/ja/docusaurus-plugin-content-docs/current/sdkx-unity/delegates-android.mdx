---
sidebar_position: 230
title: Helpshiftのデリゲート
description: "Helpshift SDKでは、アプリの開発者がヘルプセクション内でのユーザーアクティビティを追跡できるようにデリゲートコールバックが提供されています。"
---

import {
  Admonition,
  CodeBlock,
  Tabs,
  TabItem,
  LatestSdkVersion,
  Centered,
  Image,
  Intro,
  SideBySide,
  DownloadButton,
  Steps,
  Step,
} from "@site/src/components/forDocs";

# Helpshift のデリゲート {#delegates}

<Intro>

Helpshift SDK では、アプリの開発者がヘルプセクション内でのユーザーアクティビティを追跡できるようにデリゲートコールバックが提供されています。

</Intro>

<Admonition type="info" title="注意">

SDK に含まれているすべてのパブリック API は、[HelpshiftSdk.Install() API](/sdkx-unity/getting-started-android#initializing)

を介して SDK を初期化した後に呼び出す必要があります\* `Helpshift.SetHelpshiftEventsListener`を設定する前に呼び出されたイベントをもう一度受信することはできません。

</Admonition>

## Helpshift イベントリスナー/デリゲートの実装 {#event-listener}

`HelpshiftSdk.GetInstance().SetHelpshiftEventsListener()`メソッドを呼び出すことで、`IHelpshiftEventsListener`の実装を設定することができます。

### ステップ 1: IHelpshiftEventsListener インターフェースを実装する

```csharp
public class HSEventsListener: IHelpshiftEventsListener
  {
      public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
      {
          // all events
      }

      public void AuthenticationFailedForUser(HelpshiftAuthenticationFailureReason reason)
      {
          //auth failure event
      }
  }
```

### ステップ 2: Helpshift API を呼び出し、この実装クラスを設定する

```csharp
using Helpshift;
//...
//...
private HelpshiftSdk help;
//..

void Awake(){
    // install call here
    help = HelpshiftSdk.GetInstance();
    var configMap = new Dictionary<string, object>();
    // add some config

    help.Install(platformId, domainName, configMap);
}

void Start(){
    // set the listener
    help.SetHelpshiftEventsListener(new HSEventsListener());
}

```

## イベント {#helpshift-events}

### Helpshift セッションの開始イベント {#session-delegates}

このイベントは、Helpshift セッションが開始したときに発生します

- イベントの名前: `HelpshiftEvent.SDK_SESSION_STARTED`
- イベントのデータ: `null`

```csharp
public class HSEventsListener : IHelpshiftEventsListener
{
    // ...
    public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    {
      if(eventName.Equals(HelpshiftEvent.SDK_SESSION_STARTED))
      {
        Debug.Log("Helpshift session started.");
      }
    }
    //...
}
```

### Helpshift セッションの終了イベント {#session-delegates}

このイベントは、Helpshift セッションが終了したときに発生します

- イベントの名前: `HelpshiftEvent.SDK_SESSION_ENDED`
- イベントのデータ: `null`

```csharp
public class HSEventsListener : IHelpshiftEventsListener
{
    // ...
    public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    {
      if(eventName.Equals(HelpshiftEvent.SDK_SESSION_ENDED))
      {
        Debug.Log("Helpshift session ended.");
      }
    }
    //...
}
```

### 未読メッセージ数の計測イベント {#unreadMessageCount}

このイベントは、未読メッセージの数をリクエストするために`Helpshift.RequestUnreadMessageCount(shouldFetchFromServer)` API を呼び出したときに発生します。

- イベントの名前: `HelpshiftEvent.RECEIVED_UNREAD_MESSAGE_COUNT`
- イベントのデータ:
  - `HelpshiftEvent.DATA_MESSAGE_COUNT`
    - 型: `int`
  - `HelpshiftEvent.DATA_MESSAGE_COUNT_FROM_CACHE`
    - 型: `boolean`

```csharp
public class HSEventsListener : IHelpshiftEventsListener
{
    // ...
    public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    {
      if(eventName.Equals(HelpshiftEvent.RECEIVED_UNREAD_MESSAGE_COUNT))
      {
        if(eventData.ContainsKey(HelpshiftEvent.DATA_MESSAGE_COUNT)) {
          Debug.Log("Unread count: " + eventData[HelpshiftEvent.DATA_MESSAGE_COUNT]);
        }
        if(eventData.ContainsKey(HelpshiftEvent.DATA_MESSAGE_COUNT_FROM_CACHE)) {
          Debug.Log("Is Unread count from cache: " + eventData[HelpshiftEvent.DATA_MESSAGE_COUNT_FROM_CACHE]);
        }
      }
    }
    //...
}
```

### 会話の状態イベント {#conversation-status}

このイベントには、現在進行中の会話に関する情報が含まれています。

- イベントの名前: `HelpshiftEvent.CONVERSATION_STATUS`
- イベントのデータ:
  - `HelpshiftEvent.DATA_LATEST_ISSUE_ID`
    - 型: `string`
  - `HelpshiftEvent.DATA_LATEST_ISSUE_PUBLISH_ID`
    - 型: `string`
  - `HelpshiftEvent.DATA_IS_ISSUE_OPEN`
    - 型: `boolean`

```csharp
public class HSEventsListener : IHelpshiftEventsListener
{
    // ...
    public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    {
      if(eventName.Equals(HelpshiftEvent.CONVERSATION_STATUS))
      {
        if(eventData.ContainsKey(HelpshiftEvent.DATA_LATEST_ISSUE_ID)) {
          Debug.Log("Issue ID : " + eventData[HelpshiftEvent.DATA_LATEST_ISSUE_ID]);
        }
        if(eventData.ContainsKey(HelpshiftEvent.DATA_LATEST_ISSUE_PUBLISH_ID)) {
          Debug.Log("Publish ID : " + eventData[HelpshiftEvent.DATA_LATEST_ISSUE_PUBLISH_ID]);
        }
        if(eventData.ContainsKey(HelpshiftEvent.DATA_IS_ISSUE_OPEN)) {
          Debug.Log("Is issue open : " + eventData[HelpshiftEvent.DATA_IS_ISSUE_OPEN]);
        }
      }
    }
    //...
}
```

### ウィジェットの切り替えイベント {#widget-toggle-event}

このイベントは、ユーザーがチャット画面を開いたり閉じたりしたときにトリガーされます。このイベントは、`"visible"`キーのブーリアン値を用いてトリガーされます。ご参考までに、以下の例をご確認ください:

- イベントの名前: `HelpshiftEvent.WIDGET_TOGGLE`
- イベントのデータ:
  - `HelpshiftEvent.DATA_SDK_VISIBLE`
    - 型: `boolean`

```csharp
public class HSEventsListener : IHelpshiftEventsListener
{
    // ...
    public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    {
      if(eventName.Equals(HelpshiftEvent.WIDGET_TOGGLE))
      {
        if(eventData.ContainsKey(HelpshiftEvent.DATA_SDK_VISIBLE)) {
          Debug.Log("Is SDK Visible " + eventData[HelpshiftEvent.DATA_SDK_VISIBLE]);
        }
      }
    }
    //...
}
```

### ユーザーによるアクションをクリック時のイベント {#user-click-on-action}

このイベントは、ユーザーがアクションカードメッセージのリンクやアクションの呼び出しをクリックした時にトリガーされます。

- イベントの名前: `HelpshiftEvent.ACTION_CLICKED`
- イベントのデータ:
  - `HelpshiftEvent.DATA_ACTION `
  - `HelpshiftEvent.DATA_ACTION_TYPE `
  - `HelpshiftEvent.DATA_ACTION_TYPE_CALL `
  - `HelpshiftEvent.DATA_ACTION_TYPE_LINK `

| キー（定数）                         | キー（生）        | データ型 |
| ------------------------------------ | ----------------- | -------- |
| HelpshiftEvent.ACTION_CLICKED        | userClickOnAction | 文字列   |
| HelpshiftEvent.DATA_ACTION           | actionType        | 文字列   |
| HelpshiftEvent.DATA_ACTION_TYPE      | actionData        | 文字列   |
| HelpshiftEvent.DATA_ACTION_TYPE_CALL | call              | 文字列   |
| HelpshiftEvent.DATA_ACTION_TYPE_LINK | link              | 文字列   |

<Admonition type="info" title="注意">

キーの定数は、SDK X 10.3.0 以降で利用可能です。古いバージョンの SDK X では、生のキーを代わりに使用してください。

</Admonition>

```csharp
public class HSEventsListener : IHelpshiftEventsListener
{
  public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    if (eventName.Equals(HelpshiftEvent.ACTION_CLICKED)) {
          // With Key Constants
          String actionType = (String) eventData[HelpshiftEvent.DATA_ACTION_TYPE];
          String actionData = (String) eventData[HelpshiftEvent.DATA_ACTION];

          -------------------- OR --------------------

          // With Key Raw Values
          String actionType = (String) eventData["actionType"];
          String actionData = (String) eventData["actionData"];

          // `Utils.isEmpty` is null and empty Check
          if (Utils.isEmpty(actionType) || Utils.isEmpty(actionData)) {
            Debug.Log("Event Received for " + eventName + " with actionType or action Data as empty");
            return;
          }

          Debug.Log("Event Received for " + eventName + " action type " + actionType + " actionData " + actionData);
    }
}
```

### 会話の開始イベント {#conversation-start-event}

このイベントは、ユーザーが会話の中で最初のメッセージを送信したときにトリガーされます。イベントのデータオブジェクトには`message`キーが含まれており、これにはエンドユーザーが会話を始めるために送信したメッセージの文字列が含まれています。ご参考までに、以下の例をご確認ください。

- イベントの名前: `HelpshiftEvent.CONVERSATION_START`
- イベントのデータ:
  - `HelpshiftEvent.DATA_MESSAGE`
    - 型: `string`

```csharp
public class HSEventsListener : IHelpshiftEventsListener
{
    // ...
    public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    {
      if (eventName.Equals(HelpshiftEvent.CONVERSATION_START))
      {
        if(eventData.ContainsKey(HelpshiftEvent.DATA_MESSAGE)) {
          Debug.Log("Conversation started with text: " + eventData[HelpshiftEvent.DATA_MESSAGE]);
        }
      }
    }
    //...
}
```

### メッセージの追加イベント {#message-add-event}

このイベントは、ユーザーが会話内でメッセージを追加したときにトリガーされます。追加されるメッセージには、テキストメッセージ、ボットの入力を介した応答、添付ファイルなどが想定されています。イベントのデータオブジェクトには`type`キーと`body`キーが含まれており、これらはユーザーが追加したメッセージの種類と本文を示しています。ご参考までに、以下の例をご確認ください。

- イベントの名前: `HelpshiftEvent.MESSAGE_ADD`
- イベントのデータ:
  - `HelpshiftEvent.DATA_MESSAGE_TYPE`
    - 値: `HelpshiftEvent.DATA_MESSAGE_TYPE_ATTACHMENT` , `HelpshiftEvent.DATA_MESSAGE_TYPE_TEXT`
  - `HelpshiftEvent.DATA_MESSAGE_BODY`
    - 型: `string`

```csharp
public class HSEventsListener : IHelpshiftEventsListener
{
    // ...
    public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    {
      if (eventName.Equals(HelpshiftEvent.MESSAGE_ADD))
      {
        if(eventData.ContainsKey(HelpshiftEvent.DATA_MESSAGE_BODY)) {
          Debug.Log("New message added with body: " + eventData[HelpshiftEvent.DATA_MESSAGE_BODY]);
        }
        if(eventData.ContainsKey(HelpshiftEvent.DATA_MESSAGE_TYPE)) {
          Debug.Log("New message added with type: " + eventData[HelpshiftEvent.DATA_MESSAGE_TYPE]);
        }
      }
    }
    //...
}
```

### エージェントメッセージの受信イベント {#agent-message-received}

このイベントは、ユーザーが会話中にエージェントから何らかのメッセージを受信したときにトリガーされます。このデリゲートは、ボットによるメッセージや自動送信メッセージに対してはトリガーされません。

- イベントの名前: `HelpshiftEvent.AGENT_MESSAGE_RECEIVED`
- イベントのデータ:

  | キー                             | データ型              | 値                                               |
  | -------------------------------- | --------------------- | ------------------------------------------------ |
  | HelpshiftEvent.DATA_PUBLISH_ID   | 文字列                | 現在進行中の問題の会話 ID                        |
  | HelpshiftEvent.DATA_MESSAGE_TYPE | 文字列                | メッセージのメッセージ型                         |
  | HelpshiftEvent.DATA_MESSAGE_BODY | 文字列                | エージェントが送信した実際のメッセージまたは空白 |
  | HelpshiftEvent.DATA_CREATED_TIME | Long                  | ミリ秒単位の Unix エポックのタイムスタンプ       |
  | HelpshiftEvent.DATA_ATTACHMENTS  | 辞書<String, Object>> | 添付ファイル（存在する場合）                     |
  | HelpshiftEvent.DATA_URL          | 文字列                | 添付ファイルの URL                               |
  | HelpshiftEvent.DATA_CONTENT_TYPE | 文字列                | 添付ファイルの MIME タイプ                       |
  | HelpshiftEvent.DATA_FILE_NAME    | 文字列                | 添付ファイルのファイル名                         |
  | HelpshiftEvent.DATA_SIZE         | Integer               | 添付ファイルのサイズ（バイト単位）               |

<Admonition type="info" title="注意">

- このデリゲートは、10.3.0 以降のバージョンで利用可能です
- 添付ファイルのキーは、エージェントが添付ファイルを送信した場合にのみ存在します。
- エージェントが送信した添付ファイルには必要な MIME タイプや名前がない可能性があるため、ペイロードから`HelpshiftEvent.DATA_CONTENT_TYPE`が欠落する可能性があります。
  そういった場合には、ファイル名の拡張子からファイルの種類を推測することができます。
- HelpshiftEvent.DATA_MESSAGE_TYPE には、以下の種類があります。
  - HelpshiftEvent.DATA_MESSAGE_TYPE_APP_REVIEW_REQUEST
  - HelpshiftEvent.DATA_MESSAGE_TYPE_SCREENSHOT_REQUEST
  - HelpshiftEvent.DATA_MESSAGE_TYPE_TEXT

</Admonition>

```java
public class HSEventsListener : IHelpshiftEventsListener
{
  public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    if (eventName.Equals(HelpshiftEvent.AGENT_MESSAGE_RECEIVED)) {
            String publishId = (String) eventData[HelpshiftEvent.DATA_PUBLISH_ID];
            String type = (String) eventData[HelpshiftEvent.DATA_MESSAGE_TYPE];
            String body = (String) eventData[HelpshiftEvent.DATA_MESSAGE_BODY];
            long createdTs = (long) eventData[HelpshiftEvent.DATA_CREATED_TIME];

            // Utils.isEmpty() is null and empty Check
            if (Utils.isEmpty(publishId) && Utils.isEmpty(type) && Utils.isEmpty(body) && createdTs == 0) {
              Debug.Log(TAG, "Received no data");
              return;
            }

            Debug.Log("publishId " + publishId + " type " + type + " body " + body + " createdTs " + createdTs);
            List<object> attachments = (List<object>)eventData[HelpshiftEvent.DATA_ATTACHMENTS];

            if (Utils.isEmpty(attachments)) {
              Debug.Log("No attachments received in message");
            } else {

              for (int i = 0; i < attachments.size(); i++) {
                Dictionary<String, object> attachment = (Dictionary<String, object>) attachments.get(i);

                String url = (String) attachment[HelpshiftEvent.DATA_URL];
                String contentType = (String) attachment[HelpshiftEvent.DATA_CONTENT_TYPE];
                String fileName = (String) attachment[HelpshiftEvent.DATA_FILE_NAME];
                int size = (int) attachment[HelpshiftEvent.DATA_SIZE];

                if (Utils.isEmpty(url) && Utils.isEmpty(fileName) && size == 0) {
                  Debug.Log("Received no data for attachment " + (i + 1));
                  continue;
                }

                if (Utils.isEmpty(url) || Utils.isEmpty(fileName) || size == null) {
                  Debug.Log("Received incomplete data for attachment " + (i + 1));
                  continue;
                }

                Debug.Log("Attachment No. : " + (i + 1) + ", url: " + url + ", contentType: " + contentType + ", fileName: " + fileName + ", size: " + size);
              }
            }
        }
}
```

### CSAT の送信イベント {#csat-submit-event}

このイベントは、会話の終了後にユーザーが CSAT（顧客満足度）評価を送信したときにトリガーされます。イベントのデータオブジェクトには`rating`キーと`additionalFeedback`キーが含まれており、これらはユーザーが CSAT フォームを介して提供した（星による）評価と追加のコメントを示しています。ご参考までに、以下の例をご確認ください。

- イベントの名前: `HelpshiftEvent.CSAT_SUBMIT`
- イベントのデータ:
  - `HelpshiftEvent.DATA_CSAT_RATING`
    - 型: `int`
  - `HelpshiftEvent.DATA_ADDITIONAL_FEEDBACK`
    - 型: `string`

```csharp
public class HSEventsListener : IHelpshiftEventsListener
{
    // ...
    public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    {
      if (eventName.Equals(HelpshiftEvent.CSAT_SUBMIT))
      {
        if(eventData.ContainsKey(HelpshiftEvent.DATA_CSAT_RATING)) {
          Debug.Log("CSAT submitted with rating: " + eventData[HelpshiftEvent.DATA_CSAT_RATING]);
        }
        if(eventData.ContainsKey(HelpshiftEvent.DATA_ADDITIONAL_FEEDBACK)) {
          Debug.Log("CSAT submitted with rating: " + eventData[HelpshiftEvent.DATA_ADDITIONAL_FEEDBACK]);
        }
      }
    }
    //...
}
```

### 会話の終了イベント {#conversation-end-event}

このイベントは会話が終了（解決または拒否）し、再開できない場合にトリガーされます。

- イベントの名前: `HelpshiftEvent.CONVERSATION_END`
- イベントのデータ: `null`

```csharp
public class HSEventsListener : IHelpshiftEventsListener
{
    // ...
    public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    {
      if (eventName.Equals(HelpshiftEvent.CONVERSATION_END))
      {
        Debug.Log("Conversation Ended");
      }
    }
    //...
}
```

### 会話の拒否イベント {#conversation-rejected-event}

このイベントは、エージェントが会話を拒否したときにトリガーされます。

- イベントの名前: `HelpshiftEvent.CONVERSATION_REJECTED`
- イベントのデータ: `null`

```csharp
public class HSEventsListener : IHelpshiftEventsListener
{
    // ...
    public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    {
      if (eventName.Equals(HelpshiftEvent.CONVERSATION_REJECTED))
      {
        Debug.Log("Conversation Rejected");
      }
    }
    //...
}
```

### 会話の解決イベント {#conversation-resolved-event}

このイベントは、エージェントが会話を解決したときにトリガーされます。

- イベントの名前: `HelpshiftEvent.CONVERSATION_RESOLVED`
- イベントのデータ: `null`

```csharp
public class HSEventsListener : IHelpshiftEventsListener
{
    // ...
    public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    {
      if (eventName.Equals(HelpshiftEvent.CONVERSATION_RESOLVED))
      {
        Debug.Log("Conversation Resolved");
      }
    }
    //...
}
```

### 会話の再開イベント {#conversation-reopened-event}

解決に関する質問が有効化されている場合、ユーザーに対して解決の内容に満足しているかどうかが質問されます。ユーザーがそれを拒否し、新しいメッセージを送信すると会話が再開され、会話の再開イベントがトリガーされます。

イベントの名前: `HelpshiftEvent.CONVERSATION_REOPENED`

- イベントのデータ: `null`

```csharp
public class HSEventsListener : IHelpshiftEventsListener
{
    // ...
    public void HandleHelpshiftEvent(string eventName, Dictionary<string, object> eventData)
    {
      if (eventName.Equals(HelpshiftEvent.CONVERSATION_REOPENED))
      {
        Debug.Log("Conversation Reopened");
      }
    }
    //...
}
```

### ユーザー認証の失敗イベント {#user-authentication-failed-event}

ダッシュボードで`user authentication feature`が有効化された状態で`HelpshiftSdk.GetInstance().Login(userDataMap)`で無効なトークンを渡すと、理由に関する文字列とともにこのイベントを受け取ります。詳細については、[こちらを参照してください。](/sdkx-unity/users-android)

理由の種類:

- `HelpshiftAuthenticationFailureReason.INVALID_AUTH_TOKEN`
- `HelpshiftAuthenticationFailureReason.AUTH_TOKEN_NOT_PROVIDED`
- `HelpshiftAuthenticationFailureReason.UNKNOWN`

```csharp
public class HSEventsListener: IHelpshiftEventsListener
  {
      // HandleHelpshiftEvent

      public void AuthenticationFailedForUser(HelpshiftAuthenticationFailureReason reason)
      {
          Debug.Log("Authentication Failed for reason " + reason.ToString());
      }
  }
```
